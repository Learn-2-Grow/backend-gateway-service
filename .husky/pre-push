#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

echo "ğŸ” Running lint..."
npm run lint

# Check if lint made any changes
if ! git diff --quiet; then
  echo "ğŸ”§ Lint made changes, auto-committing..."
  git add .
  git commit -m "chore: auto-fix lint issues" --no-verify
  echo "âœ… Lint changes committed automatically"
else
  echo "âœ… No lint changes needed"
fi

echo "\nğŸ§ª Running tests..."
if ! npm run test; then
  echo "\nâŒ ERROR: Tests failed! Push aborted."
  echo "ğŸ“‹ Please fix the failing tests before pushing."
  exit 1
fi
echo "âœ… All tests passed\n"


# Prevent direct push to main/master
# Get the current branch name
current_branch=$(git symbolic-ref --short HEAD)

if [ "$current_branch" = "main" ] || [ "$current_branch" = "master" ]; then
  echo "âŒ ERROR: Direct push to main is not allowed!"
  echo "ğŸ“‹ Please create a feature branch and use Pull Request"
  exit 1
fi

# Generate package informations
echo "\n\nğŸ”„ Generating package informations...!!"
npm run generate:packages

if ! git diff --quiet package.md; then
  echo "ğŸ“¦ Detected changes in package.md, adding it to commit..."
  git add package.md
  git commit -m "update package.md file"
else
  echo "âœ… package.md is up to date.\n\n"
fi
